name: Tests

on:
  push:
    branches: [ master ]
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  dotnet-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enforce NovaSharp branding
        run: ./scripts/branding/ensure-novasharp-branding.sh
        shell: bash
      - name: Verify namespace alignment
        run: python3 tools/NamespaceAudit/namespace_audit.py

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln
      - name: Restore tools
        run: dotnet tool restore
      - name: Build solution
        run: dotnet build src/NovaSharp.sln -c Release --no-restore
      - name: Run interpreter tests
        run: |
          mkdir -p artifacts/test-results
          dotnet test src/tests/NovaSharp.Interpreter.Tests/NovaSharp.Interpreter.Tests.csproj -c Release --logger "trx;LogFileName=NovaSharpTests.trx" --results-directory artifacts/test-results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: NovaSharp-test-results
          path: artifacts/test-results
          if-no-files-found: error

  code-coverage:
    runs-on: ubuntu-latest
    needs: dotnet-tests
    steps:
      - uses: actions/checkout@v4
      - name: Enforce NovaSharp branding
        run: ./scripts/branding/ensure-novasharp-branding.sh
        shell: bash
      - name: Verify namespace alignment
        run: python3 tools/NamespaceAudit/namespace_audit.py

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln
      - name: Restore tools
        run: dotnet tool restore
      - name: Generate coverage
        shell: pwsh
        run: ./scripts/coverage/coverage.ps1
      - name: Publish coverage summary
        if: always()
        run: |
          if [ -f artifacts/coverage/SummaryGithub.md ]; then
            {
              echo "## Code Coverage"
              echo
              cat artifacts/coverage/SummaryGithub.md
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Coverage summary not found." >> "$GITHUB_STEP_SUMMARY"
          fi
        shell: bash
      - name: Evaluate coverage threshold
        if: always()
        uses: actions/github-script@v7
        env:
          COVERAGE_THRESHOLD: "90"
          COVERAGE_GATING_MODE: ${{ vars.COVERAGE_GATING_MODE || 'enforce' }}
        with:
          script: |
            const fs = require('fs');
            const path = 'artifacts/coverage/Summary.json';
            if (!fs.existsSync(path)) {
              core.setFailed(`Coverage summary not available at ${path}`);
              return;
            }

            const raw = JSON.parse(fs.readFileSync(path, 'utf8'));
            const summary = raw.summary ?? {};
            const line = Number(summary.linecoverage);
            const branch = Number(summary.branchcoverage);
            const method = Number(summary.methodcoverage);
            const threshold = Number(process.env.COVERAGE_THRESHOLD ?? '85');
            let mode = (process.env.COVERAGE_GATING_MODE ?? 'monitor').trim().toLowerCase();

            if (!Number.isFinite(line)) {
              core.setFailed('Line coverage percentage missing from Summary.json.');
              return;
            }

            if (!['monitor', 'enforce', 'disabled'].includes(mode)) {
              core.warning(`Unknown COVERAGE_GATING_MODE "${mode}" supplied; defaulting to monitor.`);
              mode = 'monitor';
            }

            const summaryPath = process.env.GITHUB_STEP_SUMMARY;
            const lines = [
              '### Coverage Gate',
              '',
              `- Mode: ${mode}`,
              `- Line: ${line.toFixed(2)}% (threshold ${threshold.toFixed(2)}%)`,
              `- Branch: ${Number.isFinite(branch) ? branch.toFixed(2) + '%' : 'n/a'}`,
              `- Method: ${Number.isFinite(method) ? method.toFixed(2) + '%' : 'n/a'}`,
              ''
            ];

            if (summaryPath) {
              fs.appendFileSync(summaryPath, `${lines.join('\n')}\n`);
            }

            if (mode === 'disabled') {
              core.notice('Coverage gating disabled via COVERAGE_GATING_MODE.');
              return;
            }

            const delta = line - threshold;
            if (delta < 0) {
              const message = `Line coverage ${line.toFixed(2)}% is ${Math.abs(delta).toFixed(2)}% below the ${threshold.toFixed(2)}% threshold.`;
              if (mode === 'enforce') {
                core.setFailed(`${message} Gating mode set to "enforce"; failing job.`);
              } else {
                core.warning(`${message} Monitoring mode active; job will continue. Set COVERAGE_GATING_MODE=enforce once sustained coverage meets the target.`);
              }
              return;
            }

            const success = `Line coverage ${line.toFixed(2)}% meets or exceeds the ${threshold.toFixed(2)}% threshold (mode: ${mode}).`;
            if (mode === 'enforce') {
              core.notice(success);
            } else {
              core.info(success);
            }
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'artifacts/coverage/Summary.json';
            const marker = '<!-- coverage-report -->';
            if (!fs.existsSync(path)) {
              core.warning(`Coverage summary not available at ${path}`);
              return;
            }
            const data = JSON.parse(fs.readFileSync(path, 'utf8'));
            const summary = data.summary ?? {};
            const fmt = (value) => value === undefined || value === null ? 'n/a' : `${value.toFixed(2)}%`;
            const line = summary.linecoverage ?? 0;
            const branch = summary.branchcoverage ?? 0;
            const method = summary.methodcoverage ?? 0;
            const coveredLines = summary.coveredlines ?? 0;
            const coverableLines = summary.coverablelines ?? 0;
            const coveredBranches = summary.coveredbranches ?? 0;
            const totalBranches = summary.totalbranches ?? 0;
            const coveredMethods = summary.coveredmethods ?? 0;
            const totalMethods = summary.totalmethods ?? 0;
            const body = `${marker}
            ## Code Coverage
            | Metric | Coverage |
            | --- | --- |
            | Line | ${fmt(line)} (${coveredLines}/${coverableLines}) |
            | Branch | ${fmt(branch)} (${coveredBranches}/${totalBranches}) |
            | Method | ${fmt(method)} (${coveredMethods}/${totalMethods}) |

            _Generated by coverage.ps1_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const previous = comments.find((comment) =>
              comment.user?.type === 'Bot' && comment.body?.includes(marker)
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
      - name: Archive HTML coverage
        if: always()
        run: |
          tar -czf coverage-html.tgz -C docs/coverage latest
        shell: bash
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            artifacts/coverage
            coverage-html.tgz
          if-no-files-found: error
