name: Tests

on:
  push:
    branches: [ master ]
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  dotnet-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enforce NovaSharp branding
        run: ./scripts/ensure-novasharp-branding.sh
        shell: bash
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln
      - name: Restore tools
        run: dotnet tool restore
      - name: Build solution
        run: dotnet build src/NovaSharp.sln -c Release --no-restore
      - name: Run interpreter tests
        run: |
          mkdir -p artifacts/test-results
          dotnet test src/tests/NovaSharp.Interpreter.Tests/NovaSharp.Interpreter.Tests.csproj -c Release --logger "trx;LogFileName=NovaSharpTests.trx" --results-directory artifacts/test-results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: NovaSharp-test-results
          path: artifacts/test-results
          if-no-files-found: error

  code-coverage:
    runs-on: ubuntu-latest
    needs: dotnet-tests
    steps:
      - uses: actions/checkout@v4
      - name: Enforce NovaSharp branding
        run: ./scripts/ensure-novasharp-branding.sh
        shell: bash
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln
      - name: Restore tools
        run: dotnet tool restore
      - name: Generate coverage
        shell: pwsh
        run: ./coverage.ps1
      - name: Publish coverage summary
        if: always()
        run: |
          if [ -f artifacts/coverage/SummaryGithub.md ]; then
            {
              echo "## Code Coverage"
              echo
              cat artifacts/coverage/SummaryGithub.md
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Coverage summary not found." >> "$GITHUB_STEP_SUMMARY"
          fi
        shell: bash
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'artifacts/coverage/Summary.json';
            const marker = '<!-- coverage-report -->';
            if (!fs.existsSync(path)) {
              core.warning(`Coverage summary not available at ${path}`);
              return;
            }
            const data = JSON.parse(fs.readFileSync(path, 'utf8'));
            const summary = data.summary ?? {};
            const fmt = (value) => value === undefined || value === null ? 'n/a' : `${value.toFixed(2)}%`;
            const line = summary.linecoverage ?? 0;
            const branch = summary.branchcoverage ?? 0;
            const method = summary.methodcoverage ?? 0;
            const coveredLines = summary.coveredlines ?? 0;
            const coverableLines = summary.coverablelines ?? 0;
            const coveredBranches = summary.coveredbranches ?? 0;
            const totalBranches = summary.totalbranches ?? 0;
            const coveredMethods = summary.coveredmethods ?? 0;
            const totalMethods = summary.totalmethods ?? 0;
            const body = `${marker}
            ## Code Coverage
            | Metric | Coverage |
            | --- | --- |
            | Line | ${fmt(line)} (${coveredLines}/${coverableLines}) |
            | Branch | ${fmt(branch)} (${coveredBranches}/${totalBranches}) |
            | Method | ${fmt(method)} (${coveredMethods}/${totalMethods}) |

            _Generated by coverage.ps1_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const previous = comments.find((comment) =>
              comment.user?.type === 'Bot' && comment.body?.includes(marker)
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
      - name: Archive HTML coverage
        if: always()
        run: |
          tar -czf coverage-html.tgz -C docs/coverage latest
        shell: bash
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            artifacts/coverage
            coverage-html.tgz
          if-no-files-found: error
