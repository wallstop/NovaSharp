name: Tests

on:
  push:
    branches: [ master ]
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install Python tooling deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.tooling.txt
      - name: Enforce NovaSharp branding
        run: ./scripts/branding/ensure-novasharp-branding.sh
        shell: bash
      - name: Verify namespace alignment
        run: python3 tools/NamespaceAudit/namespace_audit.py
      - name: Enforce naming conventions
        run: python3 tools/NamingAudit/naming_audit.py --namespace-prefix WallstopStudios.NovaSharp --namespace-prefix NovaSharp
      - name: Verify naming audit log
        run: python3 tools/NamingAudit/naming_audit.py --namespace-prefix WallstopStudios.NovaSharp --namespace-prefix NovaSharp --verify-log naming_audit.log
      - name: Enforce spelling conventions
        run: python3 tools/SpellingAudit/spelling_audit.py
      - name: Verify spelling audit log
        run: python3 tools/SpellingAudit/spelling_audit.py --verify-log spelling_audit.log
      - name: Generate documentation audit log
        run: python3 tools/DocumentationAudit/documentation_audit.py --write-log documentation_audit.log
      - name: Verify documentation audit log
        run: |
          if ! git diff --quiet -- documentation_audit.log; then
            echo "::error file=documentation_audit.log::documentation_audit.log is out of date. Run 'python tools/DocumentationAudit/documentation_audit.py --write-log documentation_audit.log' and commit the result."
            git --no-pager diff -- documentation_audit.log
            exit 1
          fi
      - name: Determine documentation diff base
        id: doc_diff_base
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
          BEFORE_SHA: ${{ github.event.before }}
        run: |
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            git fetch origin "$BASE_REF" --depth=1
            merge_base="$(git merge-base HEAD "origin/$BASE_REF")"
          else
            merge_base="${BEFORE_SHA:-$(git rev-parse HEAD^)}"
          fi
          echo "merge_base=$merge_base" >> "$GITHUB_OUTPUT"
      - name: Enforce script/doc README coverage
        run: ./scripts/ci/ensure-readme-updates.sh
        shell: bash
        env:
          NOVASHARP_BASE_REF: ${{ steps.doc_diff_base.outputs.merge_base }}
      - name: Verify fixture catalog is current
        shell: pwsh
        run: ./scripts/ci/check-fixture-catalog.ps1

      - name: Markdown formatting + links
        env:
          NOVASHARP_BASE_REF: ${{ steps.doc_diff_base.outputs.merge_base }}
        run: ./scripts/ci/check-markdown.sh
        shell: bash

      - name: Setup .NET (formatting gate)
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
      - name: Restore dotnet tools
        run: dotnet tool restore
      - name: CSharpier formatting gate
        run: ./scripts/ci/check-csharpier.sh
        shell: bash

      - name: Enforce PlatformAutoDetector scope usage
        run: ./scripts/ci/check-platform-testhooks.sh
        shell: bash

      - name: Enforce ConsoleCapture coordinator usage
        run: ./scripts/ci/check-console-capture-semaphore.sh
        shell: bash

      - name: Enforce shell script executable permissions
        run: ./scripts/ci/check-shell-executable.sh
        shell: bash

      - name: Enforce Python invocation pattern in shell scripts
        run: ./scripts/ci/check-shell-python-invocation.sh
        shell: bash

  dotnet-tests:
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      # Lint checks already passed in the 'lint' job (this job has needs: lint).
      # Skip redundant branding/namespace/naming/spelling/documentation/fixture-catalog steps.
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
          cache: true
          cache-dependency-path: 'src/**/packages.lock.json'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln --locked-mode
      - name: Restore tools
        run: dotnet tool restore
      - name: Build + test via helper script (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./scripts/build/build.sh --skip-tool-restore --skip-restore
        shell: bash
      - name: Build + test via helper script (Windows)
        if: runner.os == 'Windows'
        run: ./scripts/build/build.ps1 -SkipToolRestore -SkipRestore
        shell: pwsh
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: NovaSharp-test-results-${{ matrix.os }}
          path: artifacts/test-results
          if-no-files-found: error

  lint-autofix:
    needs: lint
    if: ${{ always() && github.event_name == 'pull_request' && needs.lint.result == 'failure' && github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install Python tooling deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.tooling.txt
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
          # Note: cache not needed here - this job only runs formatters, not restore
      - name: Apply repository formatters
        run: ./scripts/ci/apply-formatters.sh
        shell: bash
      - name: Detect auto-fix changes
        id: autofix_changes
        run: |
          if git status --porcelain | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create auto-fix PR
        if: steps.autofix_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: apply lint autofixes"
          branch: autofix/pr-${{ github.event.number }}-lint
          base: ${{ github.head_ref }}
          title: "Autofix lint issues for #${{ github.event.number }}"
          body: |
            This automated PR applies repository formatting fixes (CSharpier + markdownlint) detected in #${{ github.event.number }}.

            Merge this branch into `${{ github.head_ref }}` to adopt the fixes, or close it if you prefer to address the issues manually.
          labels: autofix, automation
          draft: true
      - name: No auto-fix changes detected
        if: steps.autofix_changes.outputs.changed != 'true'
        run: echo "Lint failures could not be auto-fixed (likely link issues)."

  code-coverage:
    runs-on: ubuntu-latest
    needs: dotnet-tests
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      # Lint checks already passed in the 'lint' job (via dotnet-tests dependency).
      # Skip redundant branding/namespace checks.
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln --locked-mode
      - name: Restore tools
        run: dotnet tool restore
      - name: Generate coverage
        shell: pwsh
        env:
          COVERAGE_GATING_TARGET_LINE: "96"
          COVERAGE_GATING_TARGET_BRANCH: "93"
          COVERAGE_GATING_TARGET_METHOD: "97"
          COVERAGE_GATING_MODE: enforce
        run: ./scripts/coverage/coverage.ps1 -SkipRestore
      - name: Publish coverage summary
        if: always()
        run: |
          if [ -f artifacts/coverage/SummaryGithub.md ]; then
            {
              echo "## Code Coverage"
              echo
              cat artifacts/coverage/SummaryGithub.md
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Coverage summary not found." >> "$GITHUB_STEP_SUMMARY"
          fi
        shell: bash
      - name: Evaluate coverage threshold
        if: always()
        uses: actions/github-script@v8
        env:
          COVERAGE_THRESHOLD_LINE: "96"
          COVERAGE_THRESHOLD_BRANCH: "93"
          COVERAGE_THRESHOLD_METHOD: "97"
          COVERAGE_GATING_MODE: enforce
        with:
          script: |
            const fs = require('fs');
            const path = 'artifacts/coverage/Summary.json';
            if (!fs.existsSync(path)) {
              core.setFailed(`Coverage summary not available at ${path}`);
              return;
            }

            const raw = JSON.parse(fs.readFileSync(path, 'utf8'));
            const summary = raw.summary ?? {};
            const line = Number(summary.linecoverage);
            const branch = Number(summary.branchcoverage);
            const method = Number(summary.methodcoverage);
            const lineThreshold = Number(process.env.COVERAGE_THRESHOLD_LINE ?? '95');
            const branchThreshold = Number(process.env.COVERAGE_THRESHOLD_BRANCH ?? '95');
            const methodThreshold = Number(process.env.COVERAGE_THRESHOLD_METHOD ?? '95');
            let mode = (process.env.COVERAGE_GATING_MODE ?? 'monitor').trim().toLowerCase();

            if (!Number.isFinite(line)) {
              core.setFailed('Line coverage percentage missing from Summary.json.');
              return;
            }

            if (!['monitor', 'enforce', 'disabled'].includes(mode)) {
              core.warning(`Unknown COVERAGE_GATING_MODE "${mode}" supplied; defaulting to monitor.`);
              mode = 'monitor';
            }

            const summaryPath = process.env.GITHUB_STEP_SUMMARY;
            const fmt = (value) => Number.isFinite(value) ? `${value.toFixed(2)}%` : 'n/a';
            const summaryLines = [
              '### Coverage Gate',
              '',
              `- Mode: ${mode}`,
              `- Line: ${fmt(line)} (threshold ${lineThreshold.toFixed(2)}%)`,
              `- Branch: ${fmt(branch)} (threshold ${branchThreshold.toFixed(2)}%)`,
              `- Method: ${fmt(method)} (threshold ${methodThreshold.toFixed(2)}%)`,
              ''
            ];

            if (summaryPath) {
              fs.appendFileSync(summaryPath, `${summaryLines.join('\n')}\n`);
            }

            if (mode === 'disabled') {
              core.notice('Coverage gating disabled via COVERAGE_GATING_MODE.');
              return;
            }

            const violations = [];
            const compare = (value, threshold, label) => {
              if (!Number.isFinite(value)) {
                if (threshold > 0) {
                  violations.push(`${label} coverage unavailable (threshold ${threshold.toFixed(2)}%)`);
                }
                return;
              }

              const delta = value - threshold;
              if (threshold > 0 && delta < 0) {
                violations.push(`${label} coverage ${value.toFixed(2)}% is ${Math.abs(delta).toFixed(2)}% below the ${threshold.toFixed(2)}% threshold`);
              }
            };

            compare(line, lineThreshold, 'Line');
            compare(branch, branchThreshold, 'Branch');
            compare(method, methodThreshold, 'Method');

            if (violations.length > 0) {
              const message = violations.join('; ');
              if (mode === 'enforce') {
                core.setFailed(`${message}. Gating mode set to "enforce"; failing job.`);
              } else {
                core.warning(`${message}. Monitoring mode active; job will continue.`);
              }
              return;
            }

            const success = `Line/Branch/Method coverage meet or exceed the configured thresholds (mode: ${mode}).`;
            if (mode === 'enforce') {
              core.notice(success);
            } else {
              core.info(success);
            }
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = 'artifacts/coverage/Summary.json';
            const marker = '<!-- coverage-report -->';
            if (!fs.existsSync(path)) {
              core.warning(`Coverage summary not available at ${path}`);
              return;
            }
            const data = JSON.parse(fs.readFileSync(path, 'utf8'));
            const summary = data.summary ?? {};
            const fmt = (value) => value === undefined || value === null ? 'n/a' : `${value.toFixed(2)}%`;
            const line = summary.linecoverage ?? 0;
            const branch = summary.branchcoverage ?? 0;
            const method = summary.methodcoverage ?? 0;
            const coveredLines = summary.coveredlines ?? 0;
            const coverableLines = summary.coverablelines ?? 0;
            const coveredBranches = summary.coveredbranches ?? 0;
            const totalBranches = summary.totalbranches ?? 0;
            const coveredMethods = summary.coveredmethods ?? 0;
            const totalMethods = summary.totalmethods ?? 0;
            const body = `${marker}
            ## Code Coverage
            | Metric | Coverage |
            | --- | --- |
            | Line | ${fmt(line)} (${coveredLines}/${coverableLines}) |
            | Branch | ${fmt(branch)} (${coveredBranches}/${totalBranches}) |
            | Method | ${fmt(method)} (${coveredMethods}/${totalMethods}) |

            _Generated by coverage.ps1_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const previous = comments.find((comment) =>
              comment.user?.type === 'Bot' && comment.body?.includes(marker)
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
      - name: Archive HTML coverage
        if: always()
        run: |
          tar -czf coverage-html.tgz -C docs/coverage latest
        shell: bash
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-artifacts
          path: |
            artifacts/coverage
            coverage-html.tgz
          if-no-files-found: error

  lua-comparison:
    runs-on: ubuntu-latest
    needs: dotnet-tests
    strategy:
      matrix:
        lua-version: ['5.1', '5.2', '5.3', '5.4']
      fail-fast: false
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install Lua ${{ matrix.lua-version }}
        run: |
          sudo apt-get update
          sudo apt-get install -y lua${{ matrix.lua-version }}
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln --locked-mode
      - name: Build NovaSharp CLI
        run: dotnet build src/tooling/WallstopStudios.NovaSharp.Cli/WallstopStudios.NovaSharp.Cli.csproj -c Release --no-restore
      - name: Verify Lua fixtures exist
        run: |
          if [ ! -d "src/tests/WallstopStudios.NovaSharp.Interpreter.Tests/LuaFixtures" ]; then
            echo "Error: Lua fixtures not found. Run 'python3 tools/LuaCorpusExtractor/lua_corpus_extractor_v2.py' and commit the results."
            exit 1
          fi
          fixture_count=$(find src/tests/WallstopStudios.NovaSharp.Interpreter.Tests/LuaFixtures -name "*.lua" | wc -l)
          echo "Found $fixture_count Lua fixture files"
        shell: bash
      - name: Run fixtures against Lua ${{ matrix.lua-version }}
        run: |
          bash scripts/tests/run-lua-fixtures.sh --skip-novasharp --lua-version ${{ matrix.lua-version }}
        shell: bash
      - name: Run fixtures against NovaSharp
        env:
          DOTNET_ROLL_FORWARD: Major
        run: |
          bash scripts/tests/run-lua-fixtures.sh --skip-lua --lua-version ${{ matrix.lua-version }}
        shell: bash
      - name: Compare outputs
        id: compare
        run: |
          python3 scripts/tests/compare-lua-outputs.py \
            --results-dir artifacts/lua-comparison-results \
            --corpus-dir src/tests/WallstopStudios.NovaSharp.Interpreter.Tests/LuaFixtures \
            --lua-version ${{ matrix.lua-version }} \
            --output-file artifacts/lua-comparison-results/comparison-${{ matrix.lua-version }}.json \
            --enforce
        shell: bash
      - name: Publish comparison summary
        if: always()
        run: |
          comparison_file="artifacts/lua-comparison-results/comparison-${{ matrix.lua-version }}.json"
          if [ -f "$comparison_file" ]; then
            python3 -c "
          import json
          with open('$comparison_file') as f:
              data = json.load(f)
          summary = data.get('summary', {})
          match_rate = data.get('match_rate')
          print('## Lua ${{ matrix.lua-version }} Specification Comparison')
          print()
          print('| Metric | Count |')
          print('| --- | --- |')
          print(f\"| Match | {summary.get('match', 0)} |\")
          print(f\"| Mismatch | {summary.get('mismatch', 0)} |\")
          print(f\"| Both Error | {summary.get('both_error', 0)} |\")
          print(f\"| Skipped | {summary.get('skipped', 0)} |\")
          print()
          if match_rate is not None:
              print(f'**Match Rate**: {match_rate:.1f}%')
          " >> "\$GITHUB_STEP_SUMMARY"
          else
            echo "Comparison results for Lua ${{ matrix.lua-version }} not found." >> "\$GITHUB_STEP_SUMMARY"
          fi
        shell: bash
      - name: Upload Lua ${{ matrix.lua-version }} comparison results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: lua-comparison-${{ matrix.lua-version }}
          path: artifacts/lua-comparison-results
          if-no-files-found: warn

  # Lua 5.5 comparison job (builds from source since 5.5 is not yet in package managers)
  lua-55-comparison:
    runs-on: ubuntu-latest
    needs: dotnet-tests
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libreadline-dev
      - name: Download and build Lua 5.5
        run: |
          curl -L -o lua-5.5.0-rc2.tar.gz https://www.lua.org/work/lua-5.5.0-rc2.tar.gz
          tar xzf lua-5.5.0-rc2.tar.gz
          cd lua-5.5.0-rc2
          make linux
          sudo make install INSTALL_TOP=/usr/local
          echo "/usr/local/bin" >> $GITHUB_PATH
        shell: bash
      - name: Verify Lua 5.5 installation
        run: |
          /usr/local/bin/lua -v
        shell: bash
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore src/NovaSharp.sln --locked-mode
      - name: Build NovaSharp CLI
        run: dotnet build src/tooling/WallstopStudios.NovaSharp.Cli/WallstopStudios.NovaSharp.Cli.csproj -c Release --no-restore
      - name: Verify Lua fixtures exist
        run: |
          if [ ! -d "src/tests/WallstopStudios.NovaSharp.Interpreter.Tests/LuaFixtures" ]; then
            echo "Error: Lua fixtures not found. Run 'python3 tools/LuaCorpusExtractor/lua_corpus_extractor_v2.py' and commit the results."
            exit 1
          fi
          fixture_count=$(find src/tests/WallstopStudios.NovaSharp.Interpreter.Tests/LuaFixtures -name "*.lua" | wc -l)
          echo "Found $fixture_count Lua fixture files"
        shell: bash
      - name: Run fixtures against Lua 5.5
        run: |
          bash scripts/tests/run-lua-fixtures.sh --skip-novasharp --lua-version 5.5 --lua-cmd /usr/local/bin/lua
        shell: bash
      - name: Run fixtures against NovaSharp
        env:
          DOTNET_ROLL_FORWARD: Major
        run: |
          bash scripts/tests/run-lua-fixtures.sh --skip-lua --lua-version 5.5
        shell: bash
      - name: Compare outputs
        id: compare
        run: |
          python3 scripts/tests/compare-lua-outputs.py \
            --results-dir artifacts/lua-comparison-results \
            --corpus-dir src/tests/WallstopStudios.NovaSharp.Interpreter.Tests/LuaFixtures \
            --lua-version 5.5 \
            --output-file artifacts/lua-comparison-results/comparison-5.5.json \
            --monitor
        shell: bash
      - name: Publish comparison summary
        if: always()
        run: |
          comparison_file="artifacts/lua-comparison-results/comparison-5.5.json"
          if [ -f "$comparison_file" ]; then
            python3 -c "
          import json
          with open('$comparison_file') as f:
              data = json.load(f)
          summary = data.get('summary', {})
          match_rate = data.get('match_rate')
          print('## Lua 5.5 Specification Comparison (Experimental)')
          print()
          print('> **Note**: Lua 5.5 is currently in release candidate phase. This comparison tracks compatibility progress.')
          print()
          print('| Metric | Count |')
          print('| --- | --- |')
          print(f\"| Match | {summary.get('match', 0)} |\")
          print(f\"| Mismatch | {summary.get('mismatch', 0)} |\")
          print(f\"| Both Error | {summary.get('both_error', 0)} |\")
          print(f\"| Skipped | {summary.get('skipped', 0)} |\")
          print()
          if match_rate is not None:
              print(f'**Match Rate**: {match_rate:.1f}%')
          " >> "\$GITHUB_STEP_SUMMARY"
          else
            echo "Comparison results for Lua 5.5 not found." >> "\$GITHUB_STEP_SUMMARY"
          fi
        shell: bash
      - name: Upload Lua 5.5 comparison results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: lua-comparison-5.5
          path: artifacts/lua-comparison-results
          if-no-files-found: warn
