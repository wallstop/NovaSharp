# Spec Fidelity Audit (Nov 2025)

NovaSharp aims for Lua 5.4.8 parity. When historic legacy behaviour diverges from the spec, existing tests may accidentally lock in the wrong semantics. This audit captures ongoing verification of high-risk areas so we fix the runtime (or the tests) based on the canonical Lua manuals instead of papering over defects.

## Tracking Table

| Area / File                                                                                                           | Representative Tests                                                                     | Lua 5.4 Reference                                | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                               | Status / Follow-up                                                                                                                                                                                                                                                                                                                           |
| --------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| BinaryOperatorExpression (`src/tests/NovaSharp.Interpreter.Tests/Units/BinaryOperatorExpressionTests.cs`)             | `PowerOperatorIsRightAssociative`                                                        | §3.4.1 (Arithmetic Operators)                    | Direct AST evaluation previously threw `DynamicExpressionException` because `Operator.Power` wasn’t handled in `EvalArithmetic`. Runtime updated (2025‑11‑14) to call `Math.Pow`, matching Lua’s right‑associative power semantics.                                                                                                                                                                                                                 | ✅ Fixed (tests + runtime)                                                                                                                                                                                                                                                                                                                   |
| BinaryOperatorExpression (`.../BinaryOperatorExpressionTests.cs`)                                                     | `EqualityTreatsNilAndVoidAsEqual`                                                        | §3.4.3 (Comparison Operators)                    | Test asserts `nil == void`. `DataType.Void` is an internal sentinel (e.g., `DynValue.ToScalar` returns `Void` when a function yields “no values”). Before user code can observe it, callers either translate `Void` to `Nil` (see `Processor.InstructionLoop` JNil handling) or treat `Void` as equivalent to `Nil` when comparing/assigning. Keeping the test guards against regressions where the sentinel leaks as a distinct Lua-visible value. | ✅ Spec-faithful (internal sentinel)                                                                                                                                                                                                                                                                                                         |
| TableModule (`src/tests/NovaSharp.Interpreter.Tests/Units/TableModuleTests.cs`)                                       | `PackPreservesNilAndReportsCount` / `UnpackHonorsExplicitBounds`                         | §6.6 (Table Manipulation)                        | NovaSharp’s `table.pack` exposes the Lua-specific `n` field (argument count) and preserves `nil` entries; `table.unpack` respects the optional start/end bounds. Tests exercise both behaviours, matching Lua §6.6.                                                                                                                                                                                                                                 | ✅ Spec-faithful                                                                                                                                                                                                                                                                                                                             |
| StringModule (`src/tests/NovaSharp.Interpreter.Tests/Units/StringModuleTests.cs`)                                     | `AdjustIndexClampsToBounds` / `StringRangeHandlesNegativeIndices`                        | §6.4 (String Manipulation)                       | Tests assert that helper routines mimic Lua’s 1-based indexing and negative-index adjustments. Verified against §6.4 (Lua specifies negative indices count from the end, clamped to string bounds). Implementation currently follows the spec (`StringModule.AdjustIndex` matches Lua’s behaviour).                                                                                                                                                 | ✅ Spec-faithful                                                                                                                                                                                                                                                                                                                             |
| MathModule (`src/tests/NovaSharp.Interpreter.Tests/Units/MathModuleTests.cs`)                                         | `ModfSplitsIntegerAndFractionalComponents`                                               | §6.7 (Mathematical Functions)                    | Lua’s `math.modf(x)` returns the integer part truncated toward zero and the fractional remainder (`x = i + f`, `f` has same sign as `x`). NovaSharp previously used `Math.Floor`, so `math.modf(-3.25)` yielded `-4` and `0.75` (Lua returns `-3` and `-0.25`). Runtime updated to use `Math.Truncate`, and the test now asserts the Lua-compliant tuple.                                                                                           | ✅ Fixed (runtime + test)                                                                                                                                                                                                                                                                                                                    |
| LuaTableMoveMultiVersionSpecTests (`src/tests/NovaSharp.Interpreter.Tests/Spec/LuaTableMoveMultiVersionSpecTests.cs`) | `TableMoveIsUnavailableBeforeLua53`, `TableMoveHandlesOverlappingRanges`                 | §6.6 (Table Manipulation)                        | Multi-version harness proves Lua 5.2 profiles keep `table.move` hidden while Lua 5.3+ scripts observe the spec-required behaviours (overlapping copy safety plus defaulting the destination to the source when omitted).                                                                                                                                                                                                                            | ✅ Spec-faithful (multi-version)                                                                                                                                                                                                                                                                                                             |
| LuaUtf8MultiVersionSpecTests (`src/tests/NovaSharp.Interpreter.Tests/Spec/LuaUtf8MultiVersionSpecTests.cs`)           | `Utf8LibraryIsUnavailableBeforeLua53`, `Utf8LenCountsCharactersAndFlagsInvalidSequences` | §6.5 (UTF‑8 Library)                             | Verifies that the `utf8` namespace only loads for Lua 5.3+ compatibility profiles and that `utf8.len`, `utf8.codepoint`, `utf8.offset`, `utf8.codes`, and `utf8.charpattern` all match the manual’s success/error contracts, including invalid-sequence diagnostics.                                                                                                                                                                                | ✅ Spec-faithful (multi-version)                                                                                                                                                                                                                                                                                                             |
| LuaMathMultiVersionSpecTests (`src/tests/NovaSharp.Interpreter.Tests/Spec/LuaMathMultiVersionSpecTests.cs`)           | `MathIntegerHelpersAreUnavailableBeforeLua53`, `MathUltComparesUsingUnsignedOrdering`    | §6.7 (Mathematical Functions)                    | Confirms that Lua 5.3+ profiles expose `math.type`, `math.tointeger`, and `math.ult`, that the helpers follow the integer/float detection and conversion rules from §6.7, and that Lua 5.2 compatibility continues to hide the APIs entirely.                                                                                                                                                                                                       | ✅ Spec-faithful (multi-version)                                                                                                                                                                                                                                                                                                             |
| LuaBasicMultiVersionSpecTests (`src/tests/NovaSharp.Interpreter.Tests/Spec/LuaBasicMultiVersionSpecTests.cs`)         | `ToNumberParsesIntegersAcrossSupportedBases`, `ToNumberReturnsNilWhenDigitsExceedBase`   | §6.1 (Basic Functions)                           | Exercises the refreshed `tonumber` implementation (bases 2–36, optional sign, nil on invalid digits, explicit errors when the base is outside 2–36), matching the Lua 5.4 manual and the upstream TAP fixture updates.                                                                                                                                                                                                                              | ✅ Spec-faithful (multi-version)                                                                                                                                                                                                                                                                                                             |
| Lexer / BinaryOperatorExpression (`src/tests/NovaSharp.Interpreter.Tests/Units/BitwiseOperatorTests.cs`)              | `BitwiseOperatorsRequireLua53Compatibility`, `ShiftOperatorsFollowLuaSemantics`          | §3.4.1 & §3.4.7 (Arithmetic & Bitwise Operators) | Lexer, parser, AST reduction, and VM opcodes now cover Lua 5.3+ operators (`&`, \`                                                                                                                                                                                                                                                                                                                                                                  | `, `~`, `\<\<`, `>>`, `//`) and gate them behind `LuaCompatibilityProfile.SupportsBitwiseOperators`. The new unit suite exercises compatibility errors, integer conversions (including string operands), unary `~`, shift clamping, and floor-division semantics, while `BinaryOperatorExpressionTests\` validate precedence and Eval paths. |

## Next Steps

1. Continue enumerating interpreter/unit tests, cite the relevant Lua manual section for each behaviour, and classify them as **Spec‑Faithful**, **Needs Investigation**, or **Known Divergence**.
1. For every “Needs Investigation” entry, either:
   - prove the behaviour is internal-only and document it, or
   - fix the production code / tests to match Lua, referencing the manual.
1. Record progress in this file and mirror actionable items back to `PLAN.md` and issue trackers so spec deviations are not forgotten.
