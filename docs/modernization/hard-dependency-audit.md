# Hard Dependency Audit (2025-11-21)

NovaSharp intentionally leans on host-provided abstractions (`IPlatformAccessor`, `ITimeProvider`) so embedders can stub environment-specific behavior in Unity, the CLI, or debugger hosts. Several pockets still call `Process.Start`, `DateTime.UtcNow`, or raw `System.IO` APIs directly. This document captures the current hotspots and the backlog of abstractions we should introduce before enabling broader dependency injection.

## Process Launchers

| Location                                                                          | Dependency                                 | Notes                                                                                                    | Proposed Action                                                                                                                                                                                                                 |
| --------------------------------------------------------------------------------- | ------------------------------------------ | -------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/tooling/NovaSharp.Cli/Commands/Implementations/DebugCommand.cs:12-52`        | `Process.Start(url)` via `BrowserLauncher` | CLI `debug` command spawns the OS browser directly, which fails on sandboxed hosts and is untestable.    | ✅ (2025-11-21) Introduced `NovaSharp.RemoteDebugger.IBrowserLauncher` with the default `ProcessBrowserLauncher`; `DebugCommand` now calls the abstraction (tests inject fakes).                                                |
| `src/samples/Tutorial/Tutorials/Chapters/Chapter11.cs:17-48`                      | `Process.Start(debuggerUrl)`               | Tutorial code mirrors the CLI behavior, so Unity modders copy a hard dependency on `Process`.            | ✅ (2025-11-21) Tutorial now uses `ProcessBrowserLauncher` so hosts can replace the launcher or suppress browser open entirely.                                                                                                 |
| `src/runtime/NovaSharp.Interpreter/Platforms/StandardPlatformAccessor.cs:283-296` | `Process.Start("cmd.exe", "/C …")`         | `ExecuteCommand` shells out through `cmd.exe`, which is Windows-only and bypasses Unity/mobile policies. | Extend `IPlatformAccessor` with an optional `ICommandRunner` hook so modern hosts can reject or sandbox shell commands; expose a `ScriptOptions.CommandRunner` to disable the feature by default outside Windows editor builds. |

## Filesystem Access

| Location                                                                       | Dependency                                             | Notes                                                                                                                                                  | Proposed Action                                                                                                                                                                                                                                   |
| ------------------------------------------------------------------------------ | ------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/runtime/NovaSharp.Interpreter/Modding/ModManifestCompatibility.cs:39-115` | `Directory.Exists`, `File.OpenRead`, `File.Exists`     | Manifest parsing always hits the real filesystem, making tests rely on temp folders and blocking virtualized file providers (e.g., Unity `TextAsset`). | Add an `IModFileSystem` abstraction (or reuse the upcoming host file-system provider) that exposes `OpenRead`, `FileExists`, and `ResolveDirectory`. Default implementation can wrap `System.IO`, while tests/unity can inject virtual providers. |
| `src/samples/Tutorial/Tutorials/Chapters/Chapter11.cs:50-78`                   | `Directory.Exists`, `Path.GetDirectoryName`            | Unity tutorial recursively walks disk to locate `DebuggerMod`, which makes the sample unusable once mods live outside the project tree.                | Replace with an injectable `IModLocator` (or accept a base path parameter) and update the tutorial to highlight how hosts should locate mods without crawling the filesystem.                                                                     |
| `src/tooling/NovaSharp.Cli/Commands/Implementations/HardWireCommand.cs:70-214` | `File.Exists`, `File.ReadAllText`, `File.WriteAllText` | Hardwire generation reads/writes user-specified files directly; tests spin up temp folders.                                                            | Move the file IO behind an `IFileSystem` interface shared with the manifest helper so CLI commands remain testable without touching disk.                                                                                                         |

## Time Sources

| Location                                                            | Dependency        | Notes                                                                                 | Proposed Action                                                                                                                                                                       |
| ------------------------------------------------------------------- | ----------------- | ------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/runtime/NovaSharp.Interpreter/Compatibility/Stopwatch.cs:1-30` | `DateTime.UtcNow` | The portable `Stopwatch` shim hardcodes `DateTime.UtcNow`, bypassing `ITimeProvider`. | Replace with the shared `ITimeProvider` plumbing (inject via constructor or static setter) so deterministic tests can control elapsed time on platforms that still require this shim. |

## Backlog

1. **Browser launcher abstraction** – Define `IBrowserLauncher` in `NovaSharp.Cli` (and expose a similar hook for tutorials/sample hosts), then route `DebugCommand` and `Chapter11` through it.
1. **Command runner policy** – Extend `IPlatformAccessor.ExecuteCommand` to consult a configurable `ICommandRunner` so shelling out can be disabled or sandboxed per host.
1. **File-system provider for mods/tools** – Introduce a shared `IModFileSystem`/`IFileSystem` abstraction, update `ModManifestCompatibility`, `HardWireCommand`, and Unity tutorials to accept injected providers, and add fake providers to tests.
1. **Portable stopwatch modernization** – Teach the portability shim to accept `ITimeProvider` (or drop it where `System.Diagnostics.Stopwatch` is available) so time-dependent diagnostics never consult `DateTime` directly.

Tracking these items in PLAN keeps the dependency surface visible while we layer in the remaining abstractions.
